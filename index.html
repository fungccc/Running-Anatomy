<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anatomy Master V6.9 (Running Edition)</title>
    <style>
        :root {
            --primary: #00796B;
            --primary-hover: #004D40;
            --success: #2ECC71;
            --error: #E74C3C;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text: #2c3e50;
            --text-sec: #7f8c8d;
            --border: #e0e0e0;
            --fab-color: #34495e;
            --review-color: #8e44ad;
            --option-bg: #ffffff;
            --option-hover: #e0f2f1;
            
            /* åˆ†é¡æ¨™ç±¤é¡è‰² */
            --tag-a: #E8F5E9; --tag-b: #E3F2FD; --tag-c: #FFF3E0; --tag-text: #455A64;
        }

        [data-theme="dark"] {
            --primary: #4DB6AC; --primary-hover: #80CBC4; --success: #27ae60; --error: #c0392b;
            --bg: #1a202c; --card: #2d3748; --text: #f7fafc; --text-sec: #a0aec0; --border: #4a5568;
            --fab-color: #4a5568; --review-color: #9b59b6; --option-bg: #2d3748; --option-hover: #4a5568;
            --tag-a: #1B5E20; --tag-b: #0D47A1; --tag-c: #E65100; --tag-text: #E0E0E0;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 90px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; transition: background-color 0.3s; }
        .container { background: var(--card); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); width: 100%; max-width: 600px; padding: 30px; text-align: center; position: relative; }
        h1 { margin-bottom: 5px; font-size: 28px; color: var(--primary); }
        .subtitle { color: var(--text-sec); margin-bottom: 20px; font-size: 14px; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px 0; width: 100%; display: block; font-weight: bold; transition: transform 0.1s; }
        .btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(0, 121, 107, 0.1); }
        .btn-sm { padding: 8px 15px; font-size: 14px; width: auto; display: inline-block; }
        .btn-xs { padding: 2px 8px; font-size: 11px; border-radius: 10px; cursor: pointer; border: 1px solid var(--text-sec); background: transparent; color: var(--text-sec); margin-left: 10px; }
        .btn-xs:hover { background: var(--text-sec); color: white; }

        .image-container { width: 100%; height: 260px; background: #eee; margin: 15px 0; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border); position: relative; }
        .quiz-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: filter 0.3s; }
        .blur-img { filter: blur(20px); opacity: 0.6; }

        .option-btn { background: var(--option-bg); border: 2px solid var(--border); color: var(--text); margin-bottom: 10px; text-align: left; display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .option-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.wrong { background: var(--error); color: white; border-color: var(--error); }

        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-sec); border-bottom: 3px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); width: 90%; max-width: 500px; border-radius: 12px; padding: 20px; max-height: 85vh; overflow-y: auto; text-align: left; color: var(--text); }
        
        textarea, input[type="text"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        
        .theme-toggle { position: fixed; top: 20px; right: 20px; background: none; border: none; font-size: 1.5rem; cursor: pointer; z-index: 100; }
        
        /* Footer Styling */
        .footer-tools { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; pointer-events: none; z-index: 50; padding-bottom: 20px; background: linear-gradient(to top, var(--bg) 60%, transparent); }
        .tool-btn { background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; pointer-events: auto; backdrop-filter: blur(4px); font-size: 0.85rem; }
        .brand-credit { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 8px; text-shadow: 0 1px 2px rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 1px; }
        [data-theme="dark"] .brand-credit { text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        /* Filters */
        .filter-section { margin-bottom: 15px; text-align: left; }
        .filter-header { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; color: var(--text); display: flex; align-items: center; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .checkbox-label { padding: 4px 10px; border-radius: 15px; border: 1px solid var(--border); font-size: 0.85rem; display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; color: var(--tag-text); transition: all 0.2s; }
        .cat-a .checkbox-label { background-color: var(--tag-a); } .cat-b .checkbox-label { background-color: var(--tag-b); } .cat-c .checkbox-label { background-color: var(--tag-c); }
        .checkbox-label:hover { filter: brightness(0.95); border-color: var(--primary); }
        .tag-pill { display: inline-block; background: var(--border); color: var(--text-sec); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; margin-top: 5px; }

        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }

        .stats { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text-sec); font-size: 0.9rem; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        .fab-container { position: fixed; bottom: 100px; right: 20px; z-index: 90; }
        .fab-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--fab-color); color: white; border: none; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--error); color: white; font-size: 10px; padding: 4px 7px; border-radius: 10px; display: none; }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; text-align: left; border: 1px solid var(--border); }
        .feedback.success { background: rgba(46, 204, 113, 0.1); border-color: var(--success); }
        .feedback.error { background: rgba(231, 76, 60, 0.1); border-color: var(--error); }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>

<div class="container">
    
    <div id="screen-home">
        <h1>Running Anatomy</h1>
        <p class="subtitle">V6.9 (Running Edition)</p>
        
        <div style="background:rgba(0,0,0,0.03); padding:15px; border-radius:10px; text-align:left; margin-bottom:20px; max-height:400px; overflow-y:auto; border:1px solid var(--border);">
            <div style="font-weight:bold; font-size:1rem; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ¯ ç·´ç¿’ç›®æ¨™ (Practice Goals)</span>
                <button class="btn-xs" style="font-size:12px; padding:4px 10px;" onclick="toggleGlobalAll()">Toggle All</button>
            </div>
            <div id="filter-container"></div>
        </div>

        <button class="btn" onclick="selectTime(300)">â±ï¸ 5 åˆ†é˜æŒ‘æˆ°</button>
        <button class="btn" onclick="selectTime(900)">â±ï¸ 15 åˆ†é˜æŒ‘æˆ°</button>
        <button class="btn btn-outline" onclick="selectTime(-1)">â™¾ï¸ ä¸é™æ™‚ç·´ç¿’</button>
        
        <div style="margin-top:20px; font-size:0.9rem; color:var(--text-sec);">
            æœ€é«˜åˆ†ç´€éŒ„ (5m): <span id="home-best-5m" style="color:var(--primary)">0</span>
        </div>

        <div style="margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);">
            <button class="btn btn-outline btn-sm" onclick="openImportModal()" style="color:var(--text-sec); border-color:var(--border);">
                ğŸ“‚ Data Manager
            </button>
        </div>

    </div>

    <div id="screen-settings" class="hidden">
        <h2>Settings</h2>
        
        <div style="background:var(--card); border:1px solid var(--border); padding:15px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:left;">
                <div style="font-weight:bold;">ğŸ§ æ‡¶äººè½æ›¸ (Auto Play)</div>
                <div style="font-size:0.8rem; color:var(--text-sec);">å…¨è‡ªå‹•æ’­æ”¾èˆ‡ç¿»ç‰Œã€‚</div>
            </div>
            <label class="switch"><input type="checkbox" id="passive-toggle"><span class="slider"></span></label>
        </div>

        <div style="background:var(--card); border:1px solid var(--border); padding:15px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:left;">
                <div style="font-weight:bold;">ğŸ‘‚ è½åŠ›æ¸¬é©— (Blind Mode)</div>
                <div style="font-size:0.8rem; color:var(--text-sec);">éš±è—åœ–ç‰‡ï¼Œè½éŸ³è¾¨ä½ã€‚</div>
            </div>
            <label class="switch"><input type="checkbox" id="dictation-toggle"><span class="slider"></span></label>
        </div>

        <p style="font-weight:bold;">é¸æ“‡èªè¨€ (Language):</p>
        <button class="btn" onclick="startGame('zh')"> ä¸­æ–‡æ¨¡å¼</button>
        <button class="btn" onclick="startGame('en')"> English Mode</button>
        <button class="btn btn-outline" onclick="goHome()">â†©ï¸ è¿”å› (Back)</button>
    </div>

    <div id="screen-quiz" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span id="timer-display" style="font-family:monospace; font-weight:bold; font-size:1.2rem; color:var(--primary)">00:00</span>
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="pause-btn" class="hidden" onclick="togglePause()" style="border:none; background:var(--primary); color:white; border-radius:4px; padding:2px 8px; cursor:pointer;">â¸ï¸</button>
                <span id="mode-badge" style="background:#eee; padding:2px 8px; border-radius:4px; font-size:0.8rem;">Manual</span>
            </div>
        </div>

        <div class="stats">
            <span id="score-display">âœ… 0</span>
            <span id="progress-text">Q: 1</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-bar-fill"></div></div>

        <div class="image-container">
            <img src="" class="quiz-img" id="question-img" alt="Anatomy">
            <button onclick="playFullSequence()" style="position:absolute; bottom:10px; right:10px; width:40px; height:40px; border-radius:50%; border:none; background:rgba(255,255,255,0.9); font-size:20px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);">ğŸ”Š</button>
        </div>

        <div id="options-container"></div>

        <div id="feedback-area" class="feedback">
            <h3 id="fb-title" style="margin:0 0 5px 0;"></h3>
            <div id="fb-content"></div>
        </div>

        <button id="next-btn" class="btn hidden" style="margin-top:15px; background:#34495e;" onclick="forceNext()">â¡ Next</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="endGame(false)">Exit Game</button>
    </div>

    <div id="screen-result" class="hidden">
        <h1>Finished!</h1>
        <div style="font-size:4rem; font-weight:bold; color:var(--primary);" id="final-score">0</div>
        <p>Correct Answers</p>
        <button class="btn" onclick="goHome()">ğŸ  Home</button>
        <button class="btn btn-outline" onclick="openMistakesModal()">ğŸ“ Review Mistakes</button>
    </div>

</div>

<div class="fab-container hidden" id="fab-mistakes">
    <button class="fab-btn" onclick="openMistakesModal()">ğŸ“</button>
    <span class="badge" id="mistake-badge">0</span>
</div>

<div class="footer-tools" id="main-footer">
    <div class="brand-credit">è±ç‹‚å‡ºå“ â€¢ è·‘è€…è§£å‰–å®¤</div>
</div>

<div class="modal-overlay" id="import-modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Data Manager</h3>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tab-json')">ğŸ“‹ æ–‡å­—</div>
            <div class="tab" onclick="switchTab('tab-file')">ğŸ“‚ æª”æ¡ˆ</div>
            <div class="tab" onclick="switchTab('tab-url')">ğŸŒ URL</div>
        </div>

        <div id="tab-json" class="tab-content active">
            <p style="font-size:0.85rem; color:var(--text-sec);">è²¼ä¸Š JSON:</p>
            <textarea id="import-text"></textarea>
            <button class="btn btn-sm" onclick="importFromText()">åŒ¯å…¥ (Import)</button>
        </div>

        <div id="tab-file" class="tab-content">
            <input type="file" id="file-input" accept=".json" style="margin-bottom:15px;">
            <button class="btn btn-sm" onclick="importFromFile()">è®€å– (Load)</button>
        </div>

        <div id="tab-url" class="tab-content">
            <input type="text" id="url-input" placeholder="https://..." style="margin-bottom:15px;">
            <button class="btn btn-sm" onclick="importFromUrl()">ä¸‹è¼‰ (Fetch)</button>
        </div>

        <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px; text-align:right;">
            <button class="btn btn-outline btn-sm" style="border-color:var(--error); color:var(--error); float:left;" onclick="resetData()">â†º é‡ç½®</button>
            <button class="btn btn-outline btn-sm" onclick="closeImportModal()">é—œé–‰</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mistake-modal">
    <div class="modal-content">
        <h3>My Mistakes</h3>
        <div id="mistakes-list" style="margin-bottom:15px;"></div>
        <button class="btn" style="background:var(--review-color)" onclick="startReviewMode()">ğŸ”„ Review Mistakes</button>
        <button class="btn btn-outline" onclick="closeMistakesModal()">Close</button>
    </div>
</div>

<script>
    // --- 1. TAXONOMY CONFIGURATION ---
    const taxonomy = {
        "A. è§£å‰–ä½ç½® (Anatomy)": [
            "é ­é ¸éƒ¨", "é¡±éª¨èˆ‡é¡³é¡é—œç¯€", "é ¸æ¤", "é ¸éƒ¨è‚Œç¾¤",
            "èƒŒéƒ¨èˆ‡è„ŠæŸ±", "è„ŠæŸ±éª¨éª¼", "èƒŒéƒ¨è‚Œç¾¤", "è„ŠæŸ±éŸŒå¸¶",
            "ä¸Šè‚¢", "è‚©å¸¶èˆ‡è‚©é—œç¯€", "ä¸Šè‡‚", "è‚˜éƒ¨èˆ‡å‰è‡‚", "æ‰‹è…•èˆ‡æ‰‹éƒ¨",
            "è»€å¹¹", "èƒ¸å»“", "è…¹éƒ¨èˆ‡æ ¸å¿ƒ", "éª¨ç›†å¸¶",
            "ä¸‹è‚¢", "é«–éƒ¨èˆ‡å¤§è…¿", "è†é—œç¯€", "å°è…¿", "è¸éƒ¨èˆ‡è¶³éƒ¨"
        ],
        "B. é‹å‹•å°ˆé … (Sports)": [
            "è·‘æ­¥", "ç±ƒçƒ", "è¶³çƒ", "å¥èº«/é‡è¨“", "ç¾½æ¯›çƒ", "æ¸¸æ³³", 
            "HIIT/CrossFit", "ç‘œä¼½", "å–®è»Š", "ç¶²çƒ", "æ’çƒ", 
            "æ£’çƒ/å£˜çƒ", "é«˜çˆ¾å¤«", "æ”€å²©/æŠ±çŸ³", "çš®æ‹‰ææ–¯", 
            "æ‹³æ“Š/æ ¼é¬¥", "æ¡Œçƒ", "ç™»å±±/å¥è¡Œ", "è¡æµª", "æ»‘é›ª"
        ],
        "C. åŠŸèƒ½èˆ‡å‹•ä½œ (Function)": [
            "ä¸‹è‚¢æ¨", "ä¸‹è‚¢æ‹‰/é«–çµéŠ", "ä¸Šè‚¢æ¨-æ°´å¹³", "ä¸Šè‚¢æ¨-å‚ç›´", 
            "ä¸Šè‚¢æ‹‰-æ°´å¹³", "ä¸Šè‚¢æ‹‰-å‚ç›´", "è»€å¹¹æ—‹è½‰èˆ‡å°è§’ç·š", "æ­¥æ…‹èˆ‡ç§»å‹•",
            "å±ˆæ›²", "ä¼¸å±•", "å¤–å±•", "å…§æ”¶", "å…§æ—‹", "å¤–æ—‹", "å´å±ˆ", "æ—‹å¾Œ/æ—‹å‰", 
            "æå‡/ä¸‹å£“", "èƒŒå±ˆ/è¹ å±ˆ",
            "åŸå‹•è‚Œ", "ç©©å®šè‚Œ", "æ ¸å¿ƒç©©å®š", "å‘¼å¸è¼”åŠ©", "å§¿å‹¢ç¶­æŒ", "è¡æ“Šå¸æ”¶"
        ]
    };

    // --- 2. DEFAULT DATA ---
    const defaultData = [
        { 
            id: "l01", name_en: "Gluteus Maximus", name_zh: "è‡€å¤§è‚Œ", 
            tags: ["é«–éƒ¨èˆ‡å¤§è…¿", "è·‘æ­¥", "æ’çƒ", "æ¸¸æ³³", "ä¼¸å±•", "å¤–æ—‹", "ä¸‹è‚¢æ¨", "åŸå‹•è‚Œ"], 
            img: "https://commons.wikimedia.org/wiki/Special:FilePath/Gluteus_maximus.png", 
            desc: "äººé«”æœ€å¤§è‚Œè‚‰ã€‚è² è²¬é«–é—œç¯€ä¼¸å±•(è·‘æ­¥æ¨é€²)ã€å¤–æ—‹åŠç¶­æŒç›´ç«‹ã€‚",
            desc_en: "The largest muscle in the body. Responsible for hip extension (running propulsion), external rotation, and maintaining upright posture.",
            img_source: "åœ–ç‰‡ä¾†æºï¼šç”± Wikimedia Commons æä¾›"
        }
    ];

    // --- 3. STATE ---
    let db = [];
    let currentPool = [], currentQ = null, mistakes = [];
    let config = { time: 0, lang: 'zh', dictation: false, passive: false, review: false };
    let timers = { game: null, auto: null, passive: null };
    let gameState = { score: 0, count: 0, active: false, isPaused: false };

    // --- 4. INIT ---
    window.onload = async () => {
        initTheme();
        await loadData();
        renderCategorizedFilters();
        document.getElementById('import-text').value = JSON.stringify(db, null, 2);
    };

    function initTheme() {
        const t = localStorage.getItem('theme') || 'light';
        document.body.dataset.theme = t;
    }
    function toggleTheme() {
        const n = document.body.dataset.theme === 'light' ? 'dark' : 'light';
        document.body.dataset.theme = n;
        localStorage.setItem('theme', n);
    }
    
async function loadData() {
        try {
            // è¨­å®šæ‚¨çš„ JSON æª”æ¡ˆè·¯å¾‘ (è«‹ç¢ºä¿ä¼ºæœå™¨ä¸Šæœ‰é€™å€‹è³‡æ–™å¤¾èˆ‡æª”æ¡ˆ)
            const response = await fetch('db/anatomy_data_Running.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            db = await response.json();
            console.log("âœ… æˆåŠŸè¼‰å…¥å¤–éƒ¨è³‡æ–™: db/anatomy_data_Running.json");

        } catch (error) {
            console.warn("âš ï¸ ç„¡æ³•è®€å–å¤–éƒ¨æª”æ¡ˆ (å¯èƒ½æ˜¯é›¢ç·šæˆ–è·¯å¾‘éŒ¯èª¤)ï¼Œåˆ‡æ›å› LocalStorage æˆ–é è¨­è³‡æ–™:", error);
            
            // å‚™æ¡ˆï¼šè®€å–å¤±æ•—æ™‚ï¼Œå˜—è©¦å¾ LocalStorage æˆ–ä½¿ç”¨é è¨­è³‡æ–™
            const d = localStorage.getItem('anatomy_db_v68');
            db = d ? JSON.parse(d) : JSON.parse(JSON.stringify(defaultData));
        }

        // --- è³‡æ–™è™•ç†èˆ‡æ¨™ç±¤å…¼å®¹æ€§ (ä¿æŒä¸è®Š) ---
        db.forEach(item => {
            if (!item.tags && item.cat) item.tags = [item.cat];
            else if (!item.tags) item.tags = ["Other"];
        });

        // --- è®€å–ä½¿ç”¨è€…çš„éŒ¯èª¤ç´€éŒ„èˆ‡åˆ†æ•¸ (é€™éƒ¨åˆ†ä¸€å®šè¦è®€ LocalStorage) ---
        const m = localStorage.getItem('anatomy_mistakes_v68');
        mistakes = m ? JSON.parse(m) : [];
        updateBadge();
        const stats = JSON.parse(localStorage.getItem('anatomy_stats_v68') || '{}');
        document.getElementById('home-best-5m').innerText = stats['300'] || 0;
    }

    // --- 5. RENDER FILTERS ---
    function renderCategorizedFilters() {
        const container = document.getElementById('filter-container');
        container.innerHTML = '';
        const dbTags = new Set();
        db.forEach(item => { if(Array.isArray(item.tags)) item.tags.forEach(t => dbTags.add(t)); });

        const createSection = (title, tagList, cssClass) => {
            const existingTags = tagList.filter(t => dbTags.has(t));
            if (existingTags.length === 0) return;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = `filter-section ${cssClass}`;
            const header = document.createElement('div');
            header.className = 'filter-header';
            header.innerHTML = `<span>${title}</span>`;
            const btnAll = document.createElement('button');
            btnAll.className = 'btn-xs';
            btnAll.innerText = 'â˜‘ å…¨é¸';
            btnAll.onclick = () => toggleSection(sectionDiv);
            header.appendChild(btnAll);
            sectionDiv.appendChild(header);
            const groupDiv = document.createElement('div');
            groupDiv.className = 'checkbox-group';
            existingTags.forEach(tag => {
                const lbl = document.createElement('label');
                lbl.className = 'checkbox-label';
                lbl.innerHTML = `<input type="checkbox" value="${tag}" checked onchange="autoSelectRelated(this.value, this.checked)"> ${tag}`;
                groupDiv.appendChild(lbl);
                dbTags.delete(tag);
            });
            sectionDiv.appendChild(groupDiv);
            container.appendChild(sectionDiv);
        };
        createSection("A. è§£å‰–ä½ç½® (Anatomy)", taxonomy["A. è§£å‰–ä½ç½® (Anatomy)"], "cat-a");
        createSection("B. é‹å‹•å°ˆé … (Sports)", taxonomy["B. é‹å‹•å°ˆé … (Sports)"], "cat-b");
        createSection("C. åŠŸèƒ½èˆ‡å‹•ä½œ (Function)", taxonomy["C. åŠŸèƒ½èˆ‡å‹•ä½œ (Function)"], "cat-c");

        if (dbTags.size > 0) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'filter-section';
            sectionDiv.innerHTML = `<div class="filter-header"><span>Others</span></div>`;
            const groupDiv = document.createElement('div');
            groupDiv.className = 'checkbox-group';
            Array.from(dbTags).sort().forEach(tag => {
                const lbl = document.createElement('label');
                lbl.className = 'checkbox-label';
                 lbl.innerHTML = `<input type="checkbox" value="${tag}" checked onchange="autoSelectRelated(this.value, this.checked)"> ${tag}`;
                groupDiv.appendChild(lbl);
            });
            sectionDiv.appendChild(groupDiv);
            container.appendChild(sectionDiv);
        }
    }
    function toggleSection(sectionDiv) {
        const cbs = sectionDiv.querySelectorAll('input[type="checkbox"]');
        if(cbs.length === 0) return;
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
    }
    function toggleGlobalAll() {
        const cbs = document.querySelectorAll('#filter-container input[type="checkbox"]');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
    }

    // æ–°å¢ä¸€å€‹è¼”åŠ©å‡½å¼ï¼šåˆ¤æ–·æŸå€‹æ¨™ç±¤å±¬æ–¼å“ªå€‹åˆ†é¡
    function getTagCategory(tag) {
        // taxonomy æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œç›´æ¥è®€å–
        for (const [categoryName, tags] of Object.entries(taxonomy)) {
            if (tags.includes(tag)) {
                return categoryName; // å›å‚³ä¾‹å¦‚ "A. è§£å‰–ä½ç½® (Anatomy)"
            }
        }
        return "Others"; // å¦‚æœéƒ½ä¸åœ¨é è¨­åˆ†é¡ä¸­ï¼Œæ­¸é¡ç‚º Others
    }

    // ä¿®æ”¹å¾Œçš„è‡ªå‹•å‹¾é¸é‚è¼¯
    function autoSelectRelated(tagName, isChecked) {
        if (!isChecked) return;

        // 1. å…ˆæ‰¾å‡ºã€Œè§¸ç™¼è€…ã€å±¬æ–¼å“ªå€‹åˆ†é¡ (ä¾‹å¦‚ Aå€)
        const sourceCategory = getTagCategory(tagName);

        // 2. æ‰¾å‡ºåŒ…å«æ­¤æ¨™ç±¤çš„æ‰€æœ‰é¡Œç›®
        const relatedItems = db.filter(item => item.tags && item.tags.includes(tagName));
        
        // 3. æ”¶é›†é€™äº›é¡Œç›®èº«ä¸Šçš„ã€Œå…¶ä»–æ¨™ç±¤ã€
        const tagsToSelect = new Set();
        relatedItems.forEach(item => {
            item.tags.forEach(t => tagsToSelect.add(t));
        });

        // 4. éæ­·ç•«é¢ä¸Šçš„è¤‡é¸æ¡†
        const allCheckboxes = document.querySelectorAll('#filter-container input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
            const targetTag = cb.value;
            
            // 5. åˆ¤æ–·ã€Œç›®æ¨™æ¨™ç±¤ã€å±¬æ–¼å“ªå€‹åˆ†é¡
            const targetCategory = getTagCategory(targetTag);

            // 6. æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœã€Œè§¸ç™¼è€…ã€å’Œã€Œç›®æ¨™ã€åœ¨åŒä¸€å€‹åˆ†é¡ï¼Œå°±è·³é (ä¸å‹¾é¸)
            // é™¤éæ˜¯è‡ªå·±è§¸ç™¼è‡ªå·± (é€™è¡Œå…¶å¯¦ input change å·²ç¶“è™•ç†äº†ï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹ä¸é˜»æ“‹è‡ªå·±)
            if (sourceCategory === targetCategory && tagName !== targetTag) {
                return; 
            }

            // 7. åŸ·è¡Œå‹¾é¸
            if (tagsToSelect.has(targetTag) && !cb.checked) {
                cb.checked = true;
                const label = cb.parentElement;
                label.style.transition = "background-color 0.3s";
                const originalBg = label.style.backgroundColor;
                label.style.backgroundColor = "#fff59d"; 
                setTimeout(() => { label.style.backgroundColor = originalBg; }, 500);
            }
        });
    }


    // --- 6. NAVIGATION ---
    function switchScreen(id) {
        ['screen-home', 'screen-settings', 'screen-quiz', 'screen-result'].forEach(s => 
            document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        const fab = document.getElementById('fab-mistakes');
        const footer = document.getElementById('main-footer');
        if (id === 'screen-home') { fab.classList.remove('hidden'); footer.classList.remove('hidden'); }
        else { fab.classList.add('hidden'); footer.classList.add('hidden'); }
    }

    function selectTime(sec) {
        const checked = document.querySelectorAll('#filter-container input:checked');
        if (checked.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™ç±¤ï¼"); return; }
        const selectedTags = Array.from(checked).map(c => c.value);
        currentPool = db.filter(item => {
            if(!item.tags) return false;
            return item.tags.some(t => selectedTags.includes(t));
        });
        if (currentPool.length < 2) { alert("ç¬¦åˆæ¢ä»¶çš„é¡Œç›®å¤ªå°‘ (è‡³å°‘éœ€2é¡Œ)ã€‚"); return; }
        config.time = sec; config.review = false; switchScreen('screen-settings');
    }
    function startReviewMode() {
        if (mistakes.length === 0) return;
        currentPool = [...mistakes];
        config.time = -1; config.review = true; closeMistakesModal(); switchScreen('screen-settings');
    }
    function goHome() { stopAllTimers(); window.speechSynthesis.cancel(); switchScreen('screen-home'); loadData(); }

    function startGame(lang) {
        config.lang = lang;
        config.dictation = document.getElementById('dictation-toggle').checked;
        config.passive = document.getElementById('passive-toggle').checked;

        gameState.score = 0; gameState.count = 0; gameState.active = true; gameState.isPaused = false; gameState.total = currentPool.length;
        document.getElementById('score-display').innerText = "âœ… 0";
        document.getElementById('progress-bar-fill').style.width = "0%";
        
        const badge = document.getElementById('mode-badge');
        const pauseBtn = document.getElementById('pause-btn');
        if (config.passive) {
            badge.innerText = "ğŸ§ Auto"; badge.style.background = "#FFE0B2";
            pauseBtn.classList.remove('hidden');
            pauseBtn.innerText = "â¸ï¸";
        } else {
            badge.innerText = config.dictation ? "ğŸ‘‚ Blind" : "ğŸ–ï¸ Manual";
            badge.style.background = "#eee";
            pauseBtn.classList.add('hidden');
        }

        if (config.time > 0) { gameState.timeLeft = config.time; startTimer(); }
        else document.getElementById('timer-display').innerText = "âˆ";

        switchScreen('screen-quiz');
        nextQ();
    }

    // --- 7. PAUSE LOGIC ---
    function togglePause() {
        if (!config.passive) return;
        gameState.isPaused = !gameState.isPaused;
        const btn = document.getElementById('pause-btn');
        
        if (gameState.isPaused) {
            btn.innerText = "â–¶ï¸";
            clearTimeout(timers.auto);
            clearTimeout(timers.passive);
            clearInterval(timers.game); 
            window.speechSynthesis.cancel();
        } else {
            btn.innerText = "â¸ï¸";
            if (config.time > 0) startTimer();
            const isAnswerRevealed = document.getElementById('feedback-area').style.display === 'block';
            if (isAnswerRevealed) {
                timers.auto = setTimeout(() => nextQ(), 2000); 
            } else {
                const target = Array.from(document.querySelectorAll('.option-btn')).find(b => b.dataset.id === currentQ.id);
                if (target) check(currentQ, target, true);
            }
        }
    }

    // --- 8. GAME LOGIC ---
    function nextQ() {
        if (!gameState.active) return;
        if (gameState.isPaused) return;

        if (config.review && currentPool.length === 0) { endGame(false); return; }

        clearTimeout(timers.auto); clearTimeout(timers.passive);
        document.getElementById('feedback-area').style.display = 'none';
        document.getElementById('next-btn').classList.add('hidden');

        const idx = Math.floor(Math.random() * currentPool.length);
        currentQ = currentPool[idx];
        gameState.count++;
        document.getElementById('progress-text').innerText = `Q: ${gameState.count} / ${gameState.total}`;
        
        const img = document.getElementById('question-img');
        img.src = currentQ.img;
        img.onerror = () => img.src = "https://placehold.co/600x400?text=Error";
        
        if (config.dictation) {
            img.classList.add('blur-img');
            setTimeout(playFullSequence, 600); 
        } else {
            img.classList.remove('blur-img');
        }

        let opts = [currentQ];
        let others = db.filter(x => x.id !== currentQ.id);
        while (opts.length < 4 && others.length > 0) {
            let r = others.splice(Math.floor(Math.random() * others.length), 1)[0];
            opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        const con = document.getElementById('options-container'); con.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = config.lang === 'zh' 
                ? `<b>${o.name_zh}</b> <small style="color:#888">${o.name_en}</small>`
                : `<b>${o.name_en}</b> <small style="color:#888">${o.name_zh}</small>`;
            btn.onclick = () => check(o, btn);
            btn.dataset.id = o.id;
            con.appendChild(btn);
        });

        if (config.passive) {
            document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
            if (!config.dictation) playFullSequence();
            
            timers.passive = setTimeout(() => {
                if(gameState.isPaused) return;
                const target = Array.from(document.querySelectorAll('.option-btn')).find(b => b.dataset.id === currentQ.id);
                if (target) check(currentQ, target, true);
            }, 4000); 
        }
    }

    function check(sel, btn, isAuto = false) {
        if (config.dictation) document.getElementById('question-img').classList.remove('blur-img');

        const isCorrect = sel.id === currentQ.id;
        document.querySelectorAll('.option-btn').forEach(b => {
            if (b.dataset.id === currentQ.id) b.classList.add('correct');
            else b.disabled = true;
        });

        if (!isAuto) {
            if (isCorrect) {
                gameState.score++; btn.classList.add('correct');
                if (config.review) {
                    currentPool = currentPool.filter(x => x.id !== currentQ.id);
                    mistakes = mistakes.filter(x => x.id !== currentQ.id);
                    saveMistakes();
                }
            } else {
                btn.classList.add('wrong');
                if (!config.review && !mistakes.some(x => x.id === currentQ.id)) {
                    mistakes.push(currentQ); saveMistakes();
                }
            }
        }

        document.getElementById('score-display').innerText = `âœ… ${gameState.score}`;
        const pct = config.review ? 0 : Math.min((gameState.score / gameState.count) * 100, 100);
        document.getElementById('progress-bar-fill').style.width = pct + "%";

        const fb = document.getElementById('feedback-area');
        const title = document.getElementById('fb-title');
        const content = document.getElementById('fb-content');
        
        fb.className = (isCorrect || isAuto) ? 'feedback success' : 'feedback error';
        title.innerText = isAuto ? "ğŸ§ Auto Reveal" : (isCorrect ? "âœ… Correct" : "âŒ Incorrect");
        
        // --- é¡¯ç¤ºåœ–ç‰‡ä¾†æº (NEW) ---
        let sourceHtml = '';
        if (currentQ.img_source) {
            sourceHtml = `<div style="font-size:0.75rem; color:#999; margin-top:8px; border-top:1px dashed #eee; padding-top:5px;">
                ${currentQ.img_source}
            </div>`;
        }
        // -------------------------

        let tagsHtml = '';
        if(currentQ.tags && Array.isArray(currentQ.tags)) {
            tagsHtml = '<div style="margin-top:5px;">' + currentQ.tags.map(t => `<span class="tag-pill">${t}</span>`).join('') + '</div>';
        }

        const displayDesc = config.lang === 'zh' ? (currentQ.desc || "") : (currentQ.desc_en || currentQ.desc || "");

        content.innerHTML = `
            <b>${currentQ.name_zh}</b><br>
            <span style="color:var(--primary)">${currentQ.name_en}</span><br>
            <small style="display:block; margin-top:5px; line-height:1.4;">${displayDesc}</small>
            ${tagsHtml}
            ${sourceHtml}
        `;
        fb.style.display = 'block';

        const onAudioFinished = () => {
            if (config.passive && !gameState.isPaused) {
                timers.auto = setTimeout(() => {
                    if(!gameState.isPaused) nextQ();
                }, 2000); 
            }
        };

        playFullSequence(true, onAudioFinished);

        if (!config.passive) {
            document.getElementById('next-btn').classList.remove('hidden');
        }
    }

    function forceNext() {
        if (gameState.isPaused) return;
        window.speechSynthesis.cancel();
        clearTimeout(timers.auto);
        clearTimeout(timers.passive);
        nextQ();
    }

    function endGame(fromTimer = false) {
        gameState.active = false;
        stopAllTimers();
        window.speechSynthesis.cancel();
        switchScreen('screen-result');
        document.getElementById('final-score').innerText = gameState.score;
    }

    // --- 9. AUDIO LOGIC ---
   function playFullSequence(includeDesc = false, onComplete = null) {
        if (!currentQ || gameState.isPaused) return;
        window.speechSynthesis.cancel();

        const parts = [];
        
        if (config.lang === 'zh') {
            parts.push({ text: currentQ.name_zh, lang: 'zh-TW' });
            parts.push({ text: currentQ.name_en, lang: 'en-US' });
            if (includeDesc) parts.push({ text: currentQ.desc, lang: 'zh-TW' });
        } else {
            parts.push({ text: currentQ.name_en, lang: 'en-US' });
            parts.push({ text: currentQ.name_zh, lang: 'zh-TW' });
            if (includeDesc) parts.push({ text: currentQ.desc_en || currentQ.desc, lang: 'en-US' });
        }

        speakNext(parts, 0, onComplete);
    }

    function speakNext(parts, index, onComplete) {
        if (index >= parts.length) {
            if (onComplete) onComplete(); 
            return;
        }
        if (gameState.isPaused) return;

        const p = parts[index];
        const u = new SpeechSynthesisUtterance(p.text);
        u.lang = p.lang;
        u.rate = 0.9; 

        u.onend = () => {
            if (!gameState.isPaused) speakNext(parts, index + 1, onComplete);
        };
        window.speechSynthesis.speak(u);
    }

    // --- 10. UTILITIES ---
    function startTimer() {
        updateTimer();
        timers.game = setInterval(() => {
            if(gameState.isPaused) return;
            gameState.timeLeft--;
            updateTimer();
            if (gameState.timeLeft <= 0) endGame(true);
        }, 1000);
    }
    function updateTimer() {
        const m = Math.floor(gameState.timeLeft / 60).toString().padStart(2, '0');
        const s = (gameState.timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    }
    function stopAllTimers() {
        clearInterval(timers.game); clearTimeout(timers.auto); clearTimeout(timers.passive);
    }
    function saveMistakes() {
        localStorage.setItem('anatomy_mistakes_v68', JSON.stringify(mistakes));
        updateBadge();
    }
    function updateBadge() {
        const b = document.getElementById('mistake-badge');
        b.innerText = mistakes.length;
        b.style.display = mistakes.length > 0 ? 'inline-block' : 'none';
    }

    // --- 11. IMPORT/EXPORT ---
    function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        if(id === 'tab-json') tabs[0].classList.add('active');
        if(id === 'tab-file') tabs[1].classList.add('active');
        if(id === 'tab-url') tabs[2].classList.add('active');
        document.getElementById(id).classList.add('active');
    }
    function importFromText() {
        try { const data = JSON.parse(document.getElementById('import-text').value); processNewData(data); } catch(e) { alert("JSON Error: " + e.message); }
    }
    function importFromFile() {
        const input = document.getElementById('file-input');
        if (!input.files[0]) { alert("Please select a file."); return; }
        const reader = new FileReader();
        reader.onload = function(e) { try { processNewData(JSON.parse(e.target.result)); } catch(err) { alert("File Parse Error: " + err.message); } };
        reader.readAsText(input.files[0]);
    }
    async function importFromUrl() {
        const url = document.getElementById('url-input').value;
        if (!url) { alert("Please enter a URL."); return; }
        try { const res = await fetch(url); if (!res.ok) throw new Error("Network error"); processNewData(await res.json()); } catch(e) { alert("Fetch Error: " + e.message); }
    }
    function processNewData(data) {
        if (!Array.isArray(data) || !data[0].name_zh) { alert("Format Error!"); return; }
        data.forEach(item => { if (!item.tags && item.cat) item.tags = [item.cat]; });
        db = data;
        localStorage.setItem('anatomy_db_v68', JSON.stringify(db));
        alert(`æˆåŠŸåŒ¯å…¥ ${db.length} ç­†è³‡æ–™ï¼`);
        renderCategorizedFilters(); closeImportModal();
        document.getElementById('import-text').value = JSON.stringify(db, null, 2);
    }
    function resetData() {
        if (confirm("Reset to defaults?")) {
            db = JSON.parse(JSON.stringify(defaultData));
            localStorage.removeItem('anatomy_db_v68');
            renderCategorizedFilters(); alert("Restored default data.");
            closeImportModal(); document.getElementById('import-text').value = JSON.stringify(db, null, 2);
        }
    }
    function openImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
    function closeImportModal() { document.getElementById('import-modal').style.display = 'none'; }
    function openMistakesModal() {
        const div = document.getElementById('mistakes-list'); div.innerHTML = '';
        if (mistakes.length === 0) div.innerHTML = '<p style="color:#888; text-align:center;">No mistakes yet.</p>';
        else {
            mistakes.forEach(m => {
                const d = document.createElement('div'); d.style.borderBottom = '1px solid #eee'; d.style.padding='8px 0';
                d.innerHTML = `<strong style="color:var(--error)">${m.name_zh}</strong> (${m.name_en})<br><small>${m.desc}</small>`;
                div.appendChild(d);
            });
        }
        document.getElementById('mistake-modal').style.display = 'flex';
    }
    function closeMistakesModal() { document.getElementById('mistake-modal').style.display = 'none'; }
</script>
</body>
</html>
